<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Sacred Healing Journey Hub & Chatbot</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" />
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>

  <style>
    /* --------------------------------------------------
       COLOR / TYPOGRAPHY SYSTEM – Vibrant Spiritual Palette
       -------------------------------------------------- */
    :root {
      /* Chakra‑inspired gradient colours */
      --chakra-1: #FFAFBD;  /* root – soft rose */
      --chakra-2: #ffc3a0;  /* sacral – peach */
      --chakra-3: #FFF6B7;  /* solar plexus – sunlight */
      --chakra-4: #c2ffd8;  /* heart – mint */
      --chakra-5: #a1c4fd;  /* throat – sky */
      --chakra-6: #c2e9fb;  /* third eye – ice */
      --chakra-7: #d4c1ec;  /* crown – lilac */

      --surface: rgba(255, 255, 255, 0.9);
      --surface-dark: rgba(0, 0, 0, 0.75);
      --text-primary: #252525; /* Main text color, now used for user bubble text */
      --text-secondary: #555;
      --radius-lg: 20px;
      --radius-md: 14px;
      --shadow-lg: 0 15px 40px rgba(0, 0, 0, 0.12);
      --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    /* --------------------------------------------------
       GLOBAL BASE STYLES
       -------------------------------------------------- */
    * { box-sizing: border-box; }
    html { scroll-behavior: smooth; }

    body {
      margin: 0; padding: 0 0 100px 0;
      font-family: "Quicksand", -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
      color: var(--text-primary);
      line-height: 1.6;

      background: linear-gradient(120deg, var(--chakra-1), var(--chakra-2), var(--chakra-3), var(--chakra-4), var(--chakra-5), var(--chakra-6), var(--chakra-7));
      background-size: 800% 800%;
      /* MODIFIED: Animation speed slowed by another 90% (250s -> 2500s) */
      animation: bgFlow 2500s ease infinite;
    }

    @keyframes bgFlow {
      0%   { background-position: 0% 50%; }
      50%  { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .glass {
      background: var(--surface);
      backdrop-filter: blur(24px) saturate(140%);
      -webkit-backdrop-filter: blur(24px) saturate(140%);
      border: 1px solid rgba(255,255,255,0.35);
      box-shadow: var(--shadow-lg);
    }

    /* --------------------------------------------------
       PAGE LAYOUT
       -------------------------------------------------- */
    #page-wrapper-healing {
      max-width: 900px; margin: 0 auto; padding: 48px 24px 0 24px;
    }

    /* --------------------------------------------------
       HUB SECTIONS
       -------------------------------------------------- */
    #main-healing-content .hub-section {
      margin-bottom: 48px;
      padding: 40px 36px;
      border-radius: var(--radius-lg);
      position: relative;
    }
    /*
    #main-healing-content .hub-section::before {
      content: "";
      position: absolute; inset: -2px;
      border-radius: inherit;
      padding: 2px;
      background: conic-gradient(from 0deg,var(--chakra-1),var(--chakra-2),var(--chakra-3),var(--chakra-4),var(--chakra-5),var(--chakra-6),var(--chakra-7),var(--chakra-1));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      animation: spinRing 20s linear infinite;
      pointer-events:none;
    }
    @keyframes spinRing { 0% { transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
    */

    #main-healing-content h1 {
      font-size: 36px; font-weight: 700; margin: 0 0 20px 0; text-align: center;
      color: var(--surface-dark);
      text-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    /* MODIFIED: Center specific paragraph after the main H1 */
    #main-healing-content .hub-section:first-of-type > h1 + p {
        text-align: center;
    }

    #main-healing-content h2 {
      font-size: 26px; font-weight: 600; margin: 0 0 18px 0; color: var(--surface-dark);
    }
    #main-healing-content p, #main-healing-content li {
      font-size: 17px; color: var(--text-secondary);
    }
    #main-healing-content ul { padding-left: 20px; margin-bottom: 20px; }

    .typeform-embed-container {
        background: rgba(255,255,255,0.8);
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        margin-top: 20px;
    }
    .typeform-embed-container iframe { width: 100%; height: 520px; border: none; }

    /* --------------------------------------------------
       CHATBOT
       -------------------------------------------------- */
    #math-chat-container {
      max-width: 900px; margin: 60px auto 0 auto;
      height: 75vh; min-height: 580px; display: flex; flex-direction: column;
      padding: 32px 32px 32px 32px;
      border-radius: var(--radius-lg);
      position: relative;
    }

    #math-chat-container::after {
      content: ""; position: absolute; inset: 0; border-radius: inherit;
      pointer-events: none;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.45) 0%, transparent 60%),
                  radial-gradient(circle at 70% 70%, rgba(255,255,255,0.35) 0%, transparent 60%);
      opacity: 0.25; animation: pulseAura 6s ease-in-out infinite alternate;
    }
    @keyframes pulseAura { 0% {transform: scale(0.98);} 100% {transform: scale(1.02);} }

    #math-title-container {
        text-align: center;
    }
    #math-title-container h1 {
      margin: 0 0 14px 0; font-size: 22px; font-weight: 600; color: var(--surface-dark);
    }

    #math-chatbox {
      flex-grow: 1; overflow-y: auto; border-radius: var(--radius-md);
      background: var(--surface);
      padding: 24px 20px; box-shadow: var(--shadow-sm);
      scroll-behavior: smooth;
      margin-bottom: 80px;
    }

    #math-chatbox p { margin: 0 0 16px 0; white-space: pre-wrap; word-wrap: break-word; display: block; clear: both;}

    #math-chatbox .user-message,
    #math-chatbox .bot-message {
        max-width: 72%; padding: 12px 18px;
        font-weight: 500;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        animation: pop 0.25s ease-out;
        display: inline-block;
    }

    #math-chatbox .user-message {
      float: right;
      border-radius: 22px 22px 6px 22px;
      background: linear-gradient(135deg, var(--chakra-5), var(--chakra-6));
      /* MODIFIED: User message text color to primary text (blackish) */
      color: var(--text-primary);
    }
    #math-chatbox .bot-message {
      float: left;
      border-radius: 22px 22px 22px 6px;
      background: linear-gradient(135deg, var(--chakra-2), var(--chakra-3));
      color: #4a4a4a;
    }
    @keyframes pop { 0% { transform: scale(0.95); opacity: 0;} 100% {transform: scale(1); opacity: 1;} }

    /* MODIFIED: Loading message styling to ensure left alignment and consistent bubble appearance */
    #math-chatbox .loading-message {
        font-style: italic;
        background: linear-gradient(135deg, var(--chakra-2), var(--chakra-3)) !important; /* Match bot bubble bg */
        color: #4a4a4a !important; /* Match bot bubble text color */
        box-shadow: 0 3px 10px rgba(0,0,0,0.1) !important; /* Match bot bubble shadow */
        border-radius: 22px 22px 22px 6px; /* Match bot bubble radius */
        padding: 12px 18px; /* Match bot bubble padding */
        max-width: 72%; /* Match bot bubble max-width */
        display: inline-block; /* Act like a bubble */
        float: left; /* Align left */
        /* text-align: left; -- Ensured by float:left and inline-block */
    }


    #math-chatbox .code-block {
      background: #212121; color: #f3f3f3; border: 1px solid #444; border-radius: var(--radius-md);
      padding: 14px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; position: relative; overflow-x: auto;
      clear: both; display: block; max-width: 100%;
    }
    #math-chatbox .copy-button { background: #ffb74d; color: #212121; }
    #math-chatbox .copy-button:hover { background: #ffa726; }

    /* --------------------------------------------------
       INPUT BAR
       -------------------------------------------------- */
    .math-input-container {
      position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
      width: 100%; max-width: 900px; display: flex; gap: 14px;
      padding: 18px 24px; backdrop-filter: blur(30px) saturate(160%);
      -webkit-backdrop-filter: blur(30px) saturate(160%);
      background: rgba(255,255,255,0.85); box-shadow: 0 -8px 30px rgba(0,0,0,0.08);
      border-top-left-radius: var(--radius-lg); border-top-right-radius: var(--radius-lg);
      z-index: 1000;
    }
    .math-input-container input[type="text"] {
      flex-grow: 1; padding: 14px 18px; font-size: 16px;
      border: 1px solid rgba(0,0,0,0.1); border-radius: var(--radius-md);
      background: #fff; transition: border 0.25s ease;
      font-family: "Quicksand", sans-serif;
    }
    .math-input-container input[type="text"]:focus { outline: none; border-color: var(--chakra-4); }

    .math-input-container button {
      padding: 14px 28px; font-size: 16px; font-weight: 700; cursor: pointer;
      border: none; border-radius: var(--radius-md);
      background: linear-gradient(135deg, var(--chakra-4), var(--chakra-5));
      color: #000000; /* Send button text to solid black */
      box-shadow: 0 4px 15px rgba(0,0,0,0.12); transition: transform 0.2s, box-shadow 0.2s;
    }
    .math-input-container button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
  </style>
</head>
<body>
  <div id="page-wrapper-healing">
    <div id="main-healing-content">
      <div class="hub-section glass">
        <h1>Sacred Healing Journey Hub</h1>
        <!-- This paragraph will be centered by the new CSS rule -->
        <p>A private spiritual wellness system focused on fasting, detoxification, and emotional/spiritual healing.</p>
      </div>

      <div class="hub-section glass">
        <h2>Sacred Healing Journey Hub Integration</h2>
        <p>Begin your journey by filling out the Sacred Intake Form below. Upon submission, you will receive email guidance and access to the Private Healing GPT as part of your onboarding flow.</p>
        <ul>
          <li>Sacred Intake Form</li>
          <li>Data feeds into Airtable.</li>
          <li>Immediate Email Sequence (Mailchimp)</li>
          <li>Ongoing email guidance for 7 days.</li>
        </ul>
        <div class="typeform-embed-container">
          <div data-tf-widget="IM0vqOVr" data-tf-opacity="100" data-tf-iframe-props="title=Sacred Healing Intake" data-tf-transitive-search-params data-tf-medium="snippet" style="width:100%;height:520px;"></div>
          <script src="//embed.typeform.com/next/embed.js"></script>
        </div>
      </div>

      <div class="hub-section glass">
        <h2>Private GPT-4 Healing Companion</h2>
        <p>Your personal, AI-powered companion for sacred healing. This private chatbot, driven by the latest GPT-4o model, is designed to support you on your journey.</p>
        <ul>
          <li>Accepts a Healing Name (no real names required).</li>
          <li>Powered by Sacred Circuit's custom system prompts.</li>
          <li>Conversational flow aligned with sacred healing principles.</li>
        </ul>
      </div>

      <div class="hub-section glass">
        <h2>Light Data Collection</h2>
        <p>We gather healing reflections and optional symptom tracking to help you monitor progress. No medical claims or diagnoses are made—this is purely for reflection and sovereignty.</p>
        <p><em>After your chat session, or at milestones in your journey, we invite you to share your reflections using the form below.</em></p>
        <div class="typeform-embed-container">
          <div data-tf-widget="w7br0XPD" data-tf-opacity="100" data-tf-iframe-props="title=Healing Reflections" data-tf-transitive-search-params data-tf-medium="snippet" style="width:100%;height:520px;"></div>
          <script src="//embed.typeform.com/next/embed.js"></script>
        </div>
      </div>
    </div>
  </div>

  <div id="math-chat-container" class="glass">
    <div id="math-title-container">
      <h1>Healing Companion Chatbot</h1>
    </div>
    <div id="math-chatbox">
      <p class="bot-message"><strong>Chatbot:</strong> Welcome to your sacred healing space. I am here to support you on your journey. How can I assist you today?</p>
    </div>
  </div>

  <div class="math-input-container">
    <input type="text" id="userInput" placeholder="Type your message..." />
    <button onclick="sendMessage()">Send</button>
  </div>

  <script>
    // JavaScript for the Chatbot (Functionality unchanged from your latest working version)
    let user_id = localStorage.getItem("chat_user_id");
    if (!user_id) {
      user_id = "user_" + Math.random().toString(36).substring(2, 15);
      localStorage.setItem("chat_user_id", user_id);
    }
    console.log("[Client] user_id =", user_id);

    const mathChatbox = document.getElementById("math-chatbox");
    const userInputElem = document.getElementById("userInput"); 

    async function loadConversation() {
      console.log("[Client] loadConversation() called for chat.");
      if (!mathChatbox) {
          console.error("Chatbox element not found!");
          return;
      }
      try {
        const response = await fetch(`/api/history?user_id=${user_id}`);
        if (!response.ok) {
          console.error("Failed to fetch conversation:", response.statusText);
          return;
        }
        const data = await response.json();
        const conversation = data.conversation || [];
        console.log(`[Client] Conversation length from DB = ${conversation.length}`);

        if (conversation.length > 0) {
          mathChatbox.innerHTML = "";
        }
        conversation.forEach((msg) => {
          appendMessage(msg.role, msg.content);
        });
      } catch (err) {
        console.error("[Client] Error loading conversation:", err);
      }
    }

    function appendMessage(role, text) {
      if (!mathChatbox) return;
      const p = document.createElement("p");

      if (role === "user") {
        p.classList.add("user-message");
        p.innerText = text;
      } else {
        p.classList.add("bot-message");
        let processed = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
        processed = processed.replace(
          /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,
          '<a href="$1" target="_blank" style="color: inherit;">$1</a>'
        );
        p.innerHTML = `<strong>Chatbot:</strong> ${processed}`;
      }

      mathChatbox.appendChild(p);
      scrollToBottom();

      if (typeof renderMath === "function" && text.match(/(\\\(|\\\[|\\\$).+(\\\)|\\]|\\\$)/)) {
        renderMath();
      }
      processCodeBlocks();
    }

     function processCodeBlocks() {
        if (!mathChatbox) return;
        const blocks = mathChatbox.querySelectorAll('pre code'); 
        blocks.forEach(block => {
            const pre = block.parentElement;
            if (pre.querySelector('.copy-button')) { 
                return;
            }
            if (!pre.classList.contains('code-block')) {
                pre.classList.add('code-block');
            }

            const button = document.createElement('button');
            button.classList.add('copy-button');
            button.innerText = 'Copy';
            button.onclick = () => copyCode(button);
            pre.style.position = 'relative'; 
            pre.appendChild(button);
        });
     }

    function scrollToBottom() {
      if (mathChatbox) {
        mathChatbox.scrollTop = mathChatbox.scrollHeight;
      }
    }

    async function sendMessage() {
      if (!userInputElem || !mathChatbox) {
          console.error("User input or chatbox element not found for sendMessage!");
          return;
      }
      const userMessage = userInputElem.value.trim();
      if (!userMessage) return;

      if (mathChatbox.children.length === 1 && mathChatbox.firstChild.textContent.includes("Welcome to your sacred healing space")) {
          mathChatbox.innerHTML = "";
      }

      appendMessage("user", userMessage);
      userInputElem.value = "";

      const loading = document.createElement("p");
      // Apply 'bot-message' for structural consistency (float, max-width, etc.) 
      // and 'loading-message' for specific loading text styling.
      loading.classList.add("bot-message", "loading-message"); 
      loading.innerHTML = "<strong>Chatbot:</strong> Contemplating your words...";
      mathChatbox.appendChild(loading);
      scrollToBottom();

      let partialText = "";

      try {
        const response = await fetch("/api/assistant", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id, message: userMessage }),
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error("Server error:", response.status, errorText);
            loading.innerHTML = "<strong>Chatbot:</strong> Encountered an issue. Please try again.";
            // Ensure loading message styles itself like a bot message for consistency if error persists
            loading.classList.remove("loading-message"); // Remove specific loading style, let .bot-message take over for error
            scrollToBottom();
            return;
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let sseBuffer = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          sseBuffer += chunk;
          const lines = sseBuffer.split("\n\n");
          sseBuffer = lines.pop();

          for (const line of lines) {
            if (!line.startsWith("data: ")) continue;
            const raw = line.slice("data: ".length).trim();

            if (raw === "[ERROR]") {
              loading.innerHTML = "<strong>Chatbot:</strong> Error generating response. Please try again.";
              loading.classList.remove("loading-message");
              scrollToBottom();
              return;
            }
            if (raw === "[DONE]") continue;

            try {
                const token = JSON.parse(raw);
                partialText += token;
                let safePartialText = partialText.replace(/</g, "<").replace(/>/g, ">");
                safePartialText = safePartialText.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
                safePartialText = safePartialText.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig, '<a href="$1" target="_blank" style="color: inherit;">$1</a>');
                loading.innerHTML = `<strong>Chatbot:</strong> ${safePartialText}`;
            } catch (e) {
                console.error("Error parsing token JSON:", raw, e);
            }
            scrollToBottom();
          }
        }
        if (mathChatbox.contains(loading)) {
            loading.remove();
        }
        if (partialText) {
            appendMessage("assistant", partialText);
        }

      } catch (err) {
        console.error("[Client] Error streaming SSE for chat:", err);
        if (loading && loading.parentNode === mathChatbox) {
            loading.remove();
        }
        appendMessage("assistant", "Encountered an issue processing your request. Please try again.");
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      console.log("[Client] DOMContentLoaded event. Now calling loadConversation() for chat.");
      if (userInputElem) {
        userInputElem.addEventListener("keypress", function (event) {
          if (event.key === "Enter") {
            event.preventDefault(); 
            sendMessage();
          }
        });
      } else {
          console.error("User input element not found for keypress listener!");
      }
      loadConversation();
    });

    function copyCode(button) {
      const preElement = button.closest('pre.code-block');
      const codeElement = preElement ? preElement.querySelector('code') : null;

      if (!codeElement) {
        console.error("Code element not found for copy button.");
        button.innerText = "Error";
         setTimeout(() => (button.innerText = "Copy"), 1500);
        return;
      }
      const textArea = document.createElement("textarea");
      let codeText = '';
      for (let node of codeElement.childNodes) {
          if (node.nodeType === Node.TEXT_NODE) {
              codeText += node.textContent;
          } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'BR') {
              codeText += '\n';
          } else {
              codeText += node.textContent;
          }
      }
      textArea.value = codeText.trim();
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand("copy");
      document.body.removeChild(textArea);

      button.innerText = "Copied!";
      setTimeout(() => (button.innerText = "Copy"), 1500);
    }
  </script>
  <script defer src="math-render.js"></script>
  
  <script>
    document.addEventListener('contextmenu', event => event.preventDefault());
  </script>
  <script>
    document.addEventListener('keydown', function (e) {
      if (
        e.key === 'F12' ||
        (e.ctrlKey && e.shiftKey && e.key === 'I') ||
        (e.ctrlKey && e.shiftKey && e.key === 'J') ||
        (e.ctrlKey && e.key === 'U')
      ) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>